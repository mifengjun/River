---
title: æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼šä½ çŸ¥é“AQSå®ƒæ˜¯å¹²ä»€ä¹ˆçš„å§ï¼Œé‚£è¿™ä¸ªæ¡†æ¶æ˜¯æ€ä¹ˆè®¾è®¡çš„å‘¢ï¼Ÿ
id: lvgo-design-patterns-template-method
tags: è®¾è®¡æ¨¡å¼
categories: è®¾è®¡æ¨¡å¼
excerpt: ã€€ã€€â€œä½ çŸ¥é“AQSå®ƒæ˜¯å¹²ä»€ä¹ˆçš„å§ï¼Œé‚£è¿™ä¸ªæ¡†æ¶æ˜¯æ€ä¹ˆè®¾è®¡çš„å‘¢ï¼Ÿâ€
comments: true
abbrlink: 44255
date: 2020-11-24 22:38:03
---

![template-method-title.png](https://i.loli.net/2020/11/24/65JlOrxysH82ivQ.png)

# å†²å•Šï¼

æœ€è¿‘ç»å¸¸çœ‹ã€Šå››é©±å…„å¼Ÿã€‹ï¼Œè„‘å­å·²ç»è¢«â€œå†²å•Šâ€æ´—æ‰äº†ã€‚

â€œå†²å•Šï¼Œå°±è®©æˆ‘ä»¬ä¸€è·¯é¢†å…ˆåˆ°åº•å§ï¼â€ï¼Œâ€œå†²å•Šï¼Œçœ‹æˆ‘çš„èƒœåˆ©å†²é”‹ï¼â€ï¼Œâ€œå†²å•Šï¼å…ˆé©±éŸ³é€Ÿï¼â€ï¼Œâ€œå»å§ï¼ä¸‰è§’ç®­ï¼â€ï¼Œâ€œå†²å•Šï¼ç–¾é€Ÿæ–§å¤´ï¼â€ï¼Œâ€œå†²å•Šï¼äºŒéƒä¸¸ç‰¹åˆ«å·ï¼â€ï¼Œâ€œå†²å•Šï¼â€

ç»ˆäºæ¥åˆ°äº†è®¾è®¡æ¨¡å¼çš„â€œäººæ€§â€éƒ¨åˆ†ï¼Œè¡Œä¸ºå‹æ¨¡å¼ï¼Œä¸ºä»€ä¹ˆè¯´è¡Œä¸ºå‹æ¨¡å¼æ˜¯â€œäººæ€§â€éƒ¨åˆ†å‘¢ï¼Œå› ä¸ºè¡Œä¸ºå‹æ¨¡å¼å½“ä¸­çš„ 11 ç§è®¾è®¡æ¨¡å¼å¯¹ç†è§£éƒ½éå¸¸çš„å‹å¥½å•Šã€‚æ‰€ä»¥æ¥ä¸‹æ¥çš„å†…å®¹å¯èƒ½è®©æˆ‘å­¦èµ·æ¥è¯´ä¸å®šæ›´æœ‰è¶£äº›ã€‚

# æ¨¡æ¿æ–¹æ³•æ¨¡å¼

> å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•éª¨æ¶ï¼Œå°†ç®—æ³•çš„ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ï¼Œä½¿å¾—å­ç±»åœ¨å¯ä»¥ä¸æ”¹å˜è¯¥ç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚

## å¦‚ä½•ç†è§£

å®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•éª¨æ¶ï¼Œè¯´ç™½äº†è¿™ä¸å°±æ˜¯ä¸€ä¸ªæ­¥éª¤çº¦æŸå—ï¼Ÿåœ¨çœ‹ç¬¬äºŒæ®µï¼Œå°†ç®—æ³•çš„ä¸€äº›æ­¥éª¤å»¶è¿Ÿåˆ°å­ç±»ä¸­ï¼Œæ„æ€å°±æ˜¯æ­¥éª¤é‡Œçš„ä¸€éƒ¨åˆ†ç•™ç»™ä½ äº†ï¼Œå…·ä½“æ€ä¹ˆåšçœ‹ä½ ï¼ˆå­ç±»ï¼‰è‡ªå·±äº†ã€‚ä½¿å¾—å­ç±»åœ¨å¯ä»¥ä¸æ”¹å˜è¯¥ç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ï¼Œè¿™å¥å°±æ›´å¥½ç†è§£äº†ï¼Œæœ‰äº†æ­¥éª¤çš„çº¦æŸï¼Œä½ è´Ÿè´£æ‰§è¡Œå…·ä½“çš„æ­¥éª¤ï¼Œè¯´ç™½äº†ï¼Œæ­¥éª¤åªè¦æ‰§è¡Œå°±å¯ä»¥ï¼Œä¸ç®¡ä½ æ€ä¹ˆåšï¼Œæ‰€ä»¥ä¹Ÿå°±æœ‰äº†ä¸æ”¹å˜ç»“æ„çš„æƒ…å†µä¸‹å¯ä»¥é‡æ–°å®šä¹‰ç‰¹å®šçš„æ­¥éª¤ï¼Œè¿™é‡Œçš„ç‰¹å®šæŒ‡çš„å°±æ˜¯çº¦æŸæ­¥éª¤é‡Œç•™ç»™ä½ çš„é‚£éƒ¨åˆ†æ­¥éª¤ã€‚

- æ¯”å¦‚æˆ‘ä»¬ç»å¸¸å†™ PPT çš„å°ä¼™ä¼´çŸ¥é“ï¼Œåœ¨ PPT ä¸­ï¼Œç‚¹å‡»æ–°å¢ä¸€é¡µ PPT ï¼Œåˆ›å»ºå‡ºæ¥çš„é¡µé¢ï¼Œå¤§éƒ¨åˆ†çš„å¸ƒå±€æ ¼å¼éƒ½æ˜¯å·²ç»è®¾ç½®å¥½çš„ï¼Œæˆ‘ä»¬åªéœ€è¦å»å¡«å……é‡Œé¢çš„å†…å®¹å°±å¯ä»¥äº†ã€‚

- å†æ¯”å¦‚ç»å¸¸å†™éœ€æ±‚è¯´æ˜ä¹¦çš„æ—¶å€™ï¼Œä¼šå’ŒåŒäº‹è¦ä¸€ä»½â€œæ¨¡æ¿â€ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„ä½“ç°ã€‚

- è¿˜æœ‰å¦‚æœä½ ä½¿ç”¨è¿‡ maven åˆ›å»ºè¿‡é¡¹ç›®ï¼Œé‚£è¿™ä¸ªä½ ä¸€å®šä¸é™Œç”Ÿ

![template-method-maven.png](https://i.loli.net/2020/11/24/1mWL2Nnue5A3yrF.png)

## é‡æ–°å®šä¹‰

æ¨¡æ¿æ–¹æ³•æ¨¡å¼å°±æ˜¯ï¼šæä¾›ä¸€ä¸ªå…·ä½“çš„æ­¥éª¤ï¼Œ1,2,3,4ï¼Œç°åœ¨1,2,4éƒ½å†™å¥½äº†ï¼Œæ­¥éª¤3çš„å®ç°ç”±å…·ä½“çš„æ‰§è¡Œè€…è¯´äº†ç®—ï¼Œåªè¦æ­¥éª¤ç¬¦åˆè¦æ±‚ï¼Œéšä½ å‘æŒ¥ã€‚

## æ¨¡æ¿æ–¹æ³•æ¨¡å¼ç±»å›¾ ğŸ“Œ

![template-method](https://i.loli.net/2020/11/24/RsQzpH46XNZTWcd.png)

çœ‹ç±»å›¾å°±æ˜¯æŠ½è±¡å’Œå­ç±»çš„æ ·å­ï¼Œè€Œå®é™…æ¨¡æ¿æ–¹æ³•æ¨¡å¼å°±æ˜¯åˆ©ç”¨äº†"æŠ½è±¡"ã€‚æ˜¯ä¸€ä¸ªå®Œå…¨éµå®ˆå¼€é—­åŸåˆ™çš„è®¾è®¡æ¨¡å¼ã€‚å¯ä»¥è¿™ä¹ˆè¯´ï¼Œææ‡‚äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œå¼€é—­åŸåˆ™åŸºæœ¬å°±é€šäº†ã€‚

**æ³¨æ„ï¼šæ¨¡æ¿æ–¹æ³•æ¨¡å¼ä¸­ä¸æˆ‘ä»¬å¹³æ—¶ç»§æ‰¿æŠ½è±¡ç±»æœ‰ä¸€ä¸ªå…³é”®æ€§çš„åŒºåˆ«ï¼Œå°±æ˜¯å…¥å£æ–¹æ³•ï¼Œæ­£å¸¸æŠ½è±¡ç±»ç»§æ‰¿æ˜¯ä¸éœ€è¦æœ‰è¿™ä¸ªæ‰€è°“çš„å…¥å£æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡å…¥å£æ–¹æ³•æ¥ç¡®å®šç®—æ³•çš„æ‰§è¡Œé¡ºåºï¼Œå³ç®—æ³•éª¨æ¶ã€‚**

## æˆ‘æ€ä¹ˆç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼ğŸ“ƒ

æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¯ä»¥è¯´æ˜¯éå¸¸ç®€å•çš„ä¸€ç§è®¾è®¡æ¨¡å¼äº†ï¼Œè™½ç„¶ç®€å•ï¼Œä½†å®ƒçš„ä½œç”¨å´å¾ˆå¤§ã€‚æ¯”å¦‚æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„lock é”ï¼Œå®ƒçš„å®ç°å°±åˆ©ç”¨äº† AQS ï¼Œè€Œ AQS å°±æ˜¯ä½¿ç”¨ **æ¨¡æ¿æ–¹æ³•æ¨¡å¼** ç»´æŠ¤çš„ä¸€ä¸ªé”æ¡†æ¶ï¼Œé€šè¿‡å®ƒå¯ä»¥å¿«é€Ÿçš„å¼€å‘å‡ºä¸€ä¸ªé”ã€‚è¿™æ­¥å¯ä»¥ç»“åˆ AQS çš„ä»£ç æ¥çœ‹ä¸€çœ‹ã€‚

ç¬¬ä¸€æ­¥ï¼šé€šè¿‡ Lock æ¥å£æ¥çº¦æŸä¸€ä¸ªé”æ‰€éœ€è¦çš„å‡ ä¸ªå…³é”®æ–¹æ³•ï¼ˆå…¶å®è¿™ä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€ç§æ¨¡æ¿ï¼Œåªæ˜¯çº¦æŸåŠ›å¾ˆå°ï¼‰

```java
public class MutexLock implements Lock {

    private final Sync sync = new Sync();

    @Override
    public void lock() {
        sync.acquire(1);
    }

    @Override
    public void lockInterruptibly() throws InterruptedException {
        sync.acquireInterruptibly(1);
    }

    @Override
    public boolean tryLock() {
        return sync.tryAcquire(1);
    }

    @Override
    public boolean tryLock(long time, TimeUnit unit) throws InterruptedException {
        return false;
    }

    @Override
    public void unlock() {
        sync.release(0);
    }

    @Override
    public Condition newCondition() {
        return sync.newCondition();
    }
}
```

**æ ¸å¿ƒä»£ç **

ç¬¬äºŒæ­¥ï¼šå…·ä½“çš„é”å®ç°ï¼Œè¿™ä¸ªç±»çš„çº¦æŸåŠ›æ¯”è¾ƒå¼ºï¼Œå› ä¸ºæˆ‘ä»¬æƒ³å·æ‡’ï¼Œå€ŸåŠ© AQS æ¥å®ç°ä¸€ä¸ªé”ï¼Œæ‰€ä»¥å°±è¦æŒ‰ç…§å®ƒæ‰€æä¾›çš„æ¨¡æ¿è¦æ±‚æ¥å®Œæˆå¯¹åº”æ­¥éª¤çš„ä»£ç é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„ï¼ˆä½¿å¾—å­ç±»åœ¨å¯ä»¥ä¸æ”¹å˜è¯¥ç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚ï¼‰è¿™äº›éœ€è¦æˆ‘ä»¬å»å†™çš„æ­¥éª¤å°±æ˜¯ AQS ç•™ç»™æˆ‘ä»¬çš„ â€œç‰¹æ®Šæ­¥éª¤â€

```java
final static class Sync extends AbstractQueuedSynchronizer {
        @Override
        protected boolean tryAcquire(int arg) {
            if (compareAndSetState(0, arg)) {
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            } else {
                return false;
            }
        }

        @Override
        protected boolean tryRelease(int arg) {
            if (compareAndSetState(1, arg)) {
                setExclusiveOwnerThread(null);
                return true;
            } else {
                return false;
            }
        }

        Condition newCondition() {
            return new ConditionObject();
        }
    }
```

å…³äº AQS ç•™ç»™æˆ‘ä»¬çš„ â€œç‰¹æ®Šæ­¥éª¤â€å¯ä»¥åœ¨æºç ä¸­çœ‹åˆ°

æˆ‘ä»¬è‡ªå·±å®šä¸€ä¸ªé”ï¼Œç„¶åè°ƒç”¨ acquire æ–¹æ³•

```java
public class MutexLock implements Lock {

    private final Sync sync = new Sync();

    @Override
    public void lock() {
        sync.acquire(1);
    }
```

ä¹‹å AQS æŒ‰ç…§å®ƒçš„æ¨¡æ¿ç»§ç»­æ‰§è¡Œï¼Œåœ¨éœ€è¦çš„æ—¶å€™ï¼ˆç‰¹æ®Šæ­¥éª¤ï¼‰ä¼šè°ƒç”¨æˆ‘ä»¬è‡ªå·±æä¾›çš„æ–¹æ³•ï¼Œé”å…·ä½“çš„å®ç°è¦è‡ªè¡Œå®ç°ï¼Œæ¨¡æ¿ç±» AQS ä¸æä¾›å…·ä½“å®ç°ã€‚

![template-method-AQS1.png](https://i.loli.net/2020/11/24/ruJo4M3l1SF9ILO.png)

```java
        // é‡å†™ AQS çš„ç‰¹æ®Šæ­¥éª¤ï¼Œå¦‚æœä¸å†™ä¼šæŠ›å‡ºä¸Šè¿°å¼‚å¸¸
		@Override
        protected boolean tryAcquire(int arg) {
            if (compareAndSetState(0, arg)) {
                setExclusiveOwnerThread(Thread.currentThread());
                return true;
            } else {
                return false;
            }
        }
```

é€šè¿‡ä¸€ä¸ªå›¾æ¥ç†è§£è¿™ä¸ªè¿‡ç¨‹

![template-method-AQS2.png](https://i.loli.net/2020/11/24/Vl3LZn1STyj8MbU.png)

å…¶ä¸­â€œ**ç‰¹æ®Šæ­¥éª¤**â€å°±æ˜¯ AQS æ¨¡æ¿ç•™ç»™æˆ‘ä»¬è¦å®ç°çš„åœ°æ–¹ã€‚

æœ€åï¼Œæµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬è‡ªå·±å†™çš„é”

```java
class MutexLockTest {
    private static int f = 0;

    @Test
    void lock() throws InterruptedException {
        Lock lock = new MutexLock();
        int threadCount = Runtime.getRuntime().availableProcessors();
        CountDownLatch signal = new CountDownLatch(threadCount);
        int loop = 100000;
        for (int i = 0; i < threadCount; i++) {
            Thread thread = new Thread(() -> {
                int l = 0;
                while (l < loop) {
                    lock.lock();
                    try {
                        f++;
                    } catch (Exception e) {

                    } finally {
                        lock.unlock();
                    }
                    l++;
                }
                signal.countDown();
            });
            thread.start();
        }
        signal.await();
        Assertions.assertEquals(threadCount * loop, f);
    }
```

**è¿è¡Œç»“æœ**

![template-method-test.png](https://i.loli.net/2020/11/24/bXn3FYOSryAseka.png)

è¿™é‡Œå»ºè®®å¤§å®¶é…åˆæºç å­¦ä¹ ï¼ŒåŒæ—¶ä¹Ÿèƒ½å­¦ä¹ ä¸€äº›ä¸é”å®ç°ä¸Šçš„ä¸€äº›ç›¸å…³çŸ¥è¯†ï¼Œå¦‚æœæœ‰ä¸æ¸…æ¥šæˆ–è§‰å¾—æœ‰ç–‘é—®çš„åœ°æ–¹ï¼Œæ¬¢è¿åŠ æˆ‘å¾®ä¿¡ä¸€èµ·è®¨è®ºï¼ˆlvgoccï¼‰

## æ€»ç»“ ğŸ“š

é€šè¿‡æ¨¡ç‰ˆæ¨¡å¼å¯ä»¥å°†ä¸€äº›æˆ‘ä»¬æƒ³è¦çº¦æŸçš„æ‰§è¡Œæ­¥éª¤å›ºå®šä¸‹æ¥ï¼ŒåŒæ—¶å¯¹äºæ­¥éª¤ä¸­é‡å¤çš„å†…å®¹å¯ä»¥è¿›è¡ŒæŠ½è±¡ï¼Œè¿™æ ·å°±å¯ä»¥ç®€åŒ–å¾ˆå¤šå­ç±»çš„æ“ä½œï¼Œä¹Ÿé¿å…äº†ä¸€äº›ä¸å¿…è¦çš„å†—ä½™ä»£ç äº§ç”Ÿã€‚

ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼å¯ä»¥éå¸¸ç®€å•çš„æ¥çº¦æŸä¸€æ®µé€»è¾‘çš„æ‰§è¡Œè¦æ±‚ã€‚åœ¨åšç¨‹åºæ‰©å±•é™åˆ¶æ—¶ï¼Œéå¸¸æœ‰ç”¨ã€‚å®šä¹‰å¥½å…·ä½“çš„é€»è¾‘æµç¨‹æŠ½è±¡ç±»ï¼Œå°†å…¬å…±éƒ¨åˆ†ä»£ç å†™åœ¨æŠ½è±¡ç±»ä¸­ï¼Œç„¶åå°†å…¶ä¸­éœ€è¦ä½¿ç”¨è€…è‡ªè¡Œå®ç°çš„æ–¹æ³•å®šä¹‰ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œè¿™æ ·å½“ä»–ç»§æ‰¿è¿™ä¸ªç±»çš„æ—¶å€™ï¼Œåªéœ€è¦å°†å¯¹åº”çš„æŠ½è±¡æ–¹æ³•å®ç°å°±å¥½äº†ï¼Œä¸éœ€è¦å…³ç³»å…¶å…·ä½“çš„æ‰§è¡Œé¡ºåºã€‚

ä½†åŒæ ·çš„ï¼Œè¿™æ ·ä¼šä½¿**æ‰§è¡Œé¡ºåºå¯¹ä½¿ç”¨è€…å®Œå…¨é€æ˜**ï¼Œå¦‚æœæŠ½è±¡çš„æ–¹æ³•è¾ƒä¸ºå¤æ‚æ—¶ï¼Œå¯¹äºä¸€ä¸ªåˆæ¬¡ä½¿ç”¨è¯¥é€»è¾‘çš„äººæ¥è¯´ï¼Œå‡ºç° bug å¯èƒ½ä¼šä½¿ä»–å¾ˆâ€œéš¾å—â€ï¼Œå› ä¸ºä»–éœ€è¦ææ¸…æ¥šæ•´ä¸ªæŠ½è±¡ç±»ä¸­æ¯ä¸ªæ–¹æ³•çš„æ‰§è¡Œé¡ºåºæ‰èƒ½æ›´å¥½çš„å»è§£å†³é—®é¢˜ã€‚è¿™ä¸€ç‚¹ï¼Œ**å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§**ã€‚ä¸è¿‡ï¼Œè®¾è®¡æ¨¡å¼çš„å¤æ‚æ€§ï¼Œæ˜¯ä¸å¯é¿å…çš„ã€‚**åœ¨åŠŸèƒ½å¤ç”¨ã€æé«˜ç”Ÿäº§åŠ›ä¸Šæ¥è¯´ï¼Œè¿™ç‚¹å¤æ‚æ€§çš„ä»£ä»·ï¼Œè¿˜æ˜¯èƒ½å¤Ÿæ¥å—çš„ã€‚**
